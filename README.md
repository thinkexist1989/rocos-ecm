<!--
 Copyright (c) 2021 'Yang Luo, luoyang@sia.cn'

 This software is released under the MIT License.
 https://opensource.org/licenses/MIT
-->

<div align="center">
  <img src="./rocos-ecm.png" alt="" height="150">
  <h1>ROCOS-EtherCAT-Master</h1>
  <blockquote>The EtherCAT Master for ROCOS based on Acontis Ec-Master </blockquote>
</div>

# 简介

ROCOS-EtherCAT-Master(ROCOS-Ecm)是基于Acontis Ec-Master 的EtherCAT主站实现。
其设计之初的目的是能够快速实现6自由度或7自由度机械臂关节的运动控制。主要思路是通过EcMaster从PDO中获取周期性数据，并通过共享内存的方式将数据共享来使用。

# 依赖

## 实时内核

ROCOS-ECM需要实时内核（RT-Kernel）的支持，最简单的方式就是为Linux使用Preempt-RT实时内核补丁，实时内核配置举例参见：UR实时内核配置[https://github.com/UniversalRobots/Universal_Robots_ROS_Driver/blob/395c0541b20d0da2cd480e2ad85b2100410fb043/ur_robot_driver/doc/real_time.md#L4](https://github.com/UniversalRobots/Universal_Robots_ROS_Driver/blob/395c0541b20d0da2cd480e2ad85b2100410fb043/ur_robot_driver/doc/real_time.md#L4)


> 使用范围
> ROCOS-ECM使用IntelGbe的网卡驱动，支持大部分Intel的网卡（包括i225-V及i226-V等2.5G网卡），具体支持的网卡型号可以查看Ec-Master用户手册第321页Supported
> Network Controller一节，本机的网卡型号可以通过lspci -vvv | grep -i ethernet指令查询,因基于商用主站Acontis，未授权的网卡，只能运行主站1小时。

```bash
lspci -vvv | grep -i ethernet
```

## 环境配置

ROCOS-ECM主要依赖以下库

- Boost
- Yaml-cpp
- gflags

```bash
sudo apt update
sudo apt install openssh-server net-tools ethtool rt-tests cmake libxcb-xinerama0-dev libgl1-mesa-dev -y
sudo apt-get install libncurses5-dev libssl-dev build-essential openssl libelf-dev minizip libidn11-dev libidn11 bison flex dwarves libncurses-dev zstd -y
sudo apt install libboost-all-dev libprotobuf-dev -y
sudo apt install liburdfdom-dev libtinyxml-dev libtinyxml2-dev libconsole-bridge-dev libeigen3-dev -y
sudo apt install libyaml-cpp-dev -y
```

# 下载

```bash
git clone -b dev https://github.com/thinkexist1989/rocos-ecm.git
```

# 编译及安装

> rocos-ecm的CMAKE_INSTALL_PREFIX为/opt/rocos/ecm

```bash
cd rocos-ecm/
mkdir build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Release
make -j `nproc`
sudo make install
```

编译好的可执行文件放在了build/bin目录下，其主要文件包括：

- rocos_ecm 主程序文件，运行时需要带一些参数，要以sudo运行
- eni.xml从Ec-Engineer中导出的EtherCAT网络信息文件（EtherCAT Network
  Information），rocos_ecm就是通过-f参数加载这个文件来解析EtherCAT网络拓扑结构
- atemsys.ko Ec-Master针对Linux的内核模块，主要包括经过优化的网络协议栈（实时性能更好），需要在运行主程序文件前先加载进内核sudo
  insmod atemsys.ko，但这一步可以通过脚本自动加载，后续会说明
- libemllIntelGbe.so Ec-Master公司提供的针对Intel网卡的驱动链接库程序，主程序运行时会链接到此库文件
- initECM.sh及runECM.sh 为了方便程序运行编写的脚本文件，可以通过执行两个脚本文件快速运行主站

# 配置

- 配置并生成<font color=#1E90FF>eni.xml</font>文件
  首先需要配置并生成eni.xml文件，这个工作需要使用Ec-Engineer软件来完成，具体过程可以参考 [https://www.acontis.com/en/ethercat-configuration.html](https://www.acontis.com/en/ethercat-configuration.html)

# 使用及运行

1. 不要进入/opt/rocos/ecm/bin目录，否则会找不到配置文件

```bash
 cd /opt/rocos/ecm/bin
```

2. 首先需要卸载网卡，这一步可以通过脚本自动完成，也可以手动加载

  ```bash
  sudo sh initECM.sh
  ```

> 网卡卸载示意图
<img src="https://github.com/thinkexist1989/rocos-ecm/blob/dev/image/initECM_run.png" alt="show" />

3. 以管理员身份启动主站，其命令行参数有两种方式：

- 通过命令行标志来配置。主要的命令行参数包括如下

  ```bash
  sudo ./rocos_ecm  -eni=/opt/rocos/ecm/config/eni2.xml -duration=0 -cycle=1000 -perf=1 -sp=6000  -link=2 -instance=6 -mode=1     
  ```

  <table>
  <tr>
  <td width=20% bgcolor=#4169E1>标志</td>
  <td width=30% bgcolor=#FF7F50>格式</td>
  <td width=20% bgcolor=#008000>参数类型</td>
    <td bgcolor=#FFD700>说明</td>
  </tr>
  <tr>
  <th ><font color=#1E90FF>-eni</font></th>
  <th><font color=#1E90FF>-eni (eniFileName)</font></th>
  <th><font color=#1E90FF>int32</font> </th>	
    <th><font color=#1E90FF>Path to ENI file. Note: On Windows CE absolute file paths are needed "/opt/rocos/ecm/config/eni.xml", "Defaults path to ENI file in XML format."</font> </th>	
  </tr>
  <tr>
  <th ><font color=#1E90FF>-duration</font></th>
  <th><font color=#1E90FF>-duration (time)</font></th>
  <th><font color=#1E90FF>int32</font> </th>	
    <th><font color=#1E90FF>(time): Time in msec, 0 = forever (default = 120000).Running duration in msec. When the time expires, the demo application exits completely. Defaults to 0</font> </th>	
  </tr>
  <tr>
  <th ><font color=#1E90FF>-cycle</font></th>
  <th><font color=#1E90FF>-cycle(cycle time)</font></th>
  <th><font color=#1E90FF>int32</font> </th>	
    <th><font color=#1E90FF>(cycle time): Bus cycle time in μsec.Specifies the bus cycle time. Defaults to 1000μs (1ms). </font> </th>	
  </tr>
  <tr>
  <th ><font color=#1E90FF>-verbose</font></th>
  <th><font color=#1E90FF>-verbose (level)</font></th>
  <th><font color=#1E90FF>int32</font> </th>	
    <th><font color=#1E90FF>(level): Verbosity level: 0=off (default), 1..n=more messages. The verbosity level specifies how much console output messages will be generated by the demo application. A high verbosity level leads to more messages. Defaults to 3.</font> </th>	
  </tr>
  <tr>
  <th ><font color=#1E90FF>-cpuidx</font></th>
  <th><font color=#1E90FF>-cpuidx (affinity)</font></th>
  <th><font color=#1E90FF>nt32</font> </th>	
    <th><font color=#1E90FF>(affinity): 0 = first CPU, 1 = second, ...

The CPU affinity specifies which CPU the demo application ought to . Defaults to 0.</font> </th>
</tr>
  <tr>
		<th ><font color=#1E90FF>-perf</font></th>
		<th><font color=#1E90FF>-perf</font></th>
		<th><font color=#1E90FF>bool（可以无参数）</font> </th>	
    <th><font color=#1E90FF>Enable max. and average time measurement in μs for all EtherCAT jobs (e.g. ProcessAllRxFrames). Defaults to true.</font> </th>	
	</tr>
  <tr>
		<th ><font color=#1E90FF>-sp</font></th>
		<th><font color=#1E90FF>-sp[port]</font></th>
		<th><font color=#1E90FF>int32</font> </th>	
    <th><font color=#1E90FF>If platform has support for IP Sockets, this commandline option enables the Remote API Server to be started with the EcMasterDemo. The Remote API Server is going to listen on TCP Port 6000 (or port parameter if given) and is available for connecting Remote API Clients. This option is included for attaching the EC-Lyser Application to the running master. Defaults to 0xFFFF.</font> </th>	
	</tr>
  <tr>
		<th ><font color=#1E90FF>-log </font></th>
		<th><font color=#1E90FF>-log [prefix]</font></th>
		<th><font color=#1E90FF>string</font> </th>	
    <th><font color=#1E90FF>Use given file name prefix for log files. Defaults to 1.</font> </th>	
	</tr>
  <tr>
		<th ><font color=#1E90FF>-link</font></th>
		<th><font color=#1E90FF>-link(no)</font></th>
		<th><font color=#1E90FF>int32</font> </th>	
    <th><font color=#1E90FF>0 is i8254x, 1 is i8255x Hardware: Intel Pro/1000 network adapter card. Defaults to 0. </font> </th>	
	</tr>
  <tr>
		<th ><font color=#1E90FF>-instance</font></th>
		<th><font color=#1E90FF>-instance (no)</font></th>
		<th><font color=#1E90FF>string</font> </th>	
    <th><font color=#1E90FF>(instance): Device instance , 网卡的顺序，例如有两个网卡。地址分别为04：00.0 06：00.0，如想使用06：00.0作为主站，instance=2 . Defaults to "01::00.0".</font> </th>	
	</tr>
  <tr>
		<th ><font color=#1E90FF>-cpuidx</font></th>
		<th><font color=#1E90FF>-config (cfgFileName)</font></th>
		<th><font color=#1E90FF>string</font> </th>	
    <th><font color=#1E90FF>Path to ecat_config file. </font> </th>	
	</tr>
  <tr>
		<th ><font color=#1E90FF>-mode</font></th>
		<th><font color=#1E90FF>-mode(no)</font></th>
		<th><font color=#1E90FF>int32</font> </th>	
    <th><font color=#1E90FF>(mode): Mode 0 = Interrupt mode, 1= Polling mode. Defaults to 1.</font> </th>	
	</tr>
   <tr>
		<th ><font color=#1E90FF>-dcmmode</font></th>
		<th><font color=#1E90FF>-dcmmode(no)</font></th>
		<th><font color=#1E90FF>int32</font> </th>	
    <th><font color=#1E90FF>0 = off, 1 = busshift, 2 = mastershift. </font> Defaults to 1.</th>	
	</tr>
</table>

- 将参数放入配置文件，通过--flagfile参数启动。flagfile里面包含了启动主站所需的配置参数，配置好的flagfile默认放在/opt/rocos/ecm/config目录下

  ```bash 
  sudo ./rocos_ecm -flagfile ../config/ecm.flagfile
  ```

  ```bash
  ## ecm.flagfile
  --eni=/opt/rocos/ecm/config/eni2.xml
  --id=0
  --duration=0
  --cycle=1000
  --perf=1
  --sp=6000
  --link=2
  --instance=6
  --mode=1
  ```

## 运行成功示意图及视频

> 主站运行流程示意

<img src="https://github.com/thinkexist1989/rocos-ecm/blob/dev/image/start.gif" alt="show" />

<img src="https://github.com/thinkexist1989/rocos-ecm/blob/dev/image/run.png" alt="show" />



---

:bust_in_silhouette:

- **Yang Luo (yluo@hit.edu.cn)**
- **Jincheng Sun (2390104@stu.neu.edu.cn)**